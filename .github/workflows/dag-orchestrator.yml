name: DAG Orchestrator

on:
  workflow_dispatch:
    inputs:
      trigger-repo:
        description: 'Repository that triggered the build (e.g., fireflyframework-cache)'
        required: true
        type: string
      build-all:
        description: 'Build all repos regardless of changes'
        required: false
        default: false
        type: boolean
      mode:
        description: 'What to trigger on downstream repos: ci (rebuild) or release (publish + release)'
        required: false
        default: 'ci'
        type: choice
        options:
          - ci
          - release

permissions:
  contents: read
  actions: write

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      layers: ${{ steps.affected.outputs.layers }}
    steps:
      - name: Checkout CLI
        uses: actions/checkout@v4
        with:
          repository: fireflyframework/fireflyframework-cli
          ref: main

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build CLI
        run: go build -o flywork .

      - name: Compute affected repos with layers
        id: affected
        run: |
          if [ "${{ inputs.build-all }}" = "true" ]; then
            LAYERS=$(./flywork dag export --json | jq -c '.layers')
          else
            LAYERS=$(./flywork dag affected --from "${{ inputs.trigger-repo }}" --layers --json | jq -c '.layers')
          fi
          echo "layers=$LAYERS" >> "$GITHUB_OUTPUT"
          echo "Layer plan:"
          echo "$LAYERS" | jq '.'

  dispatch:
    needs: plan
    if: needs.plan.outputs.layers != '[]' && needs.plan.outputs.layers != 'null'
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch layer by layer
        env:
          GH_TOKEN: ${{ secrets.ORG_DISPATCH_TOKEN }}
          LAYERS: ${{ needs.plan.outputs.layers }}
        run: |
          MODE="${{ inputs.mode }}"
          WORKFLOW="ci.yml"
          REF="develop"
          if [ "$MODE" = "release" ]; then
            WORKFLOW="release.yml"
            REF="main"
          fi

          LAYER_COUNT=$(echo "$LAYERS" | jq 'length')
          for i in $(seq 0 $((LAYER_COUNT - 1))); do
            REPOS=$(echo "$LAYERS" | jq -r ".[$i][]")
            echo "=== Layer $i ==="

            # Dispatch all repos in this layer
            PIDS=""
            for REPO in $REPOS; do
              echo "  Dispatching $WORKFLOW on $REPO..."
              gh api --method POST \
                repos/fireflyframework/${REPO}/actions/workflows/${WORKFLOW}/dispatches \
                -f ref=${REF} &
              PIDS="$PIDS $!"
            done

            # Wait for all dispatches in this layer
            for PID in $PIDS; do wait $PID; done

            # Wait for workflows to complete before next layer
            echo "  Waiting for layer $i workflows to complete..."
            for REPO in $REPOS; do
              # Poll for workflow completion (max 30 min per layer)
              for attempt in $(seq 1 60); do
                RUN_ID=$(gh api "repos/fireflyframework/${REPO}/actions/workflows/${WORKFLOW}/runs?per_page=1" \
                  --jq '.workflow_runs[0] | select(.status != "completed") | .id' 2>/dev/null || true)
                if [ -z "$RUN_ID" ]; then
                  STATUS=$(gh api "repos/fireflyframework/${REPO}/actions/workflows/${WORKFLOW}/runs?per_page=1" \
                    --jq '.workflow_runs[0].conclusion' 2>/dev/null || echo "unknown")
                  echo "  $REPO completed: $STATUS"
                  if [ "$STATUS" != "success" ]; then
                    echo "::error::$REPO failed with status: $STATUS"
                    exit 1
                  fi
                  break
                fi
                sleep 30
              done
            done

            echo "=== Layer $i complete ==="
          done
